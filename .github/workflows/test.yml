name: test
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  appleos:
    strategy:
      fail-fast: false
      matrix:
        xcode:
          - latest
          #- latest-stable
        destination:
          - 'platform=macOS,arch=x86_64'
          #- 'platform=macOS,arch=arm64'
          - 'platform=iOS Simulator,OS=latest,name=iPhone 15 Pro'
          - 'platform=tvOS Simulator,OS=latest,name=Apple TV 4K'
          - 'platform=watchOS Simulator,OS=latest,name=Apple Watch Series 9 - 45mm'
    runs-on: macos-13
    steps:
    - name: Select latest available Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode }}
    - name: Checkout
      uses: actions/checkout@v4
    - name: Run tests for ${{ matrix.destination }}
      run: |
        xcodebuild test -scheme StructuredAPIClient-Package \
                        -enableThreadSanitizer YES \
                        -destination '${{ matrix.destination }}'
  
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ver:
          - swift:5.9-jammy
          - swiftlang/swift:nightly-5.10-jammy
          - swiftlang/swift:nightly-main-jammy
    container:
      image: ${{ matrix.ver }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Run tests for ${{ matrix.ver }}
      run: swift test --sanitize=thread
